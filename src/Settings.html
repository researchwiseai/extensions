<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  </head>
  <body>
    <div class="container">
      <h5>Settings</h5>
      <!-- Disconnected state: show email input and Connect button -->
      <div id="disconnectedSection">
        <div class="input-field">
          <input id="email" type="email">
          <label for="email">Email Address</label>
        </div>
        <button id="connectButton" class="btn waves-effect waves-light" onclick="lookupOrganization()">Connect</button>
      </div>
      <!-- Connected state: show status and Disconnect button -->
      <div id="connectedSection" style="display: none;">
        <p><span class="green-text text-darken-2">Connected</span></p>
        <button id="disconnectButton" class="btn waves-effect waves-light" onclick="disconnect()">Disconnect</button>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <?/* Pass in webBase from server: used for registration URL */?>
    <script>
      const webBase = '<?= webBase ?>';
      function onFailure(err) {
        M.toast({html: 'Error: ' + err.message});
      }
      function onOrgFound(res) {
        if (res.success) {
          M.toast({html: 'Organization found: ' + res.orgId});
          authorize();
        } else if (res.notFound) {
          M.toast({
            html: 'No account found for that email address. To <a href="' + webBase + '/register" target="_blank">register for ResearchWiseAI, click here</a>.',
          });
        } else {
          M.toast({html: 'Error finding organization'});
        }
      }
      function lookupOrganization() {
        const email = document.getElementById('email').value;
        google.script.run
          .withSuccessHandler(onOrgFound)
          .withFailureHandler(onFailure)
          .findOrganization(email);
      }
      function authorize() {
        google.script.run
          .withSuccessHandler(function(url) { window.open(url, '_blank'); })
          .withFailureHandler(onFailure)
          .getAuthorizationUrl();
      }
      // Fetch current settings (email & auth status), then render UI
      function loadSettings() {
        google.script.run
          .withSuccessHandler(renderSettings)
          .withFailureHandler(onFailure)
          .getSettings();
      }
      // Render UI based on authorization status
      function renderSettings(res) {
        const connected = res.isAuthorized;
        document.getElementById('connectedSection').style.display = connected ? '' : 'none';
        document.getElementById('disconnectedSection').style.display = connected ? 'none' : '';
        if (!connected) {
          document.getElementById('email').value = res.email || '';
          M.updateTextFields();
        }
      }
      // Disconnect user and refresh UI
      function disconnect() {
        google.script.run
          .withSuccessHandler(loadSettings)
          .withFailureHandler(onFailure)
          .disconnect();
      }
      document.addEventListener('DOMContentLoaded', function() {
        M.AutoInit();
        loadSettings();
      });
    </script>
  </body>
</html>